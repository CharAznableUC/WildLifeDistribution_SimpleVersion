<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="initial-scale=1,maximum-scale=1,user-scalable=no" />
  <title>ç‚¹å‡»èšåˆç‚¹æ”¾å¤§åœ°å›¾ - V4å®Œæ•´ä¿®å¤ç‰ˆ</title>
  
  <!-- ArcGIS Maps SDK for JavaScript -->
  <link rel="stylesheet" href="https://js.arcgis.com/4.28/esri/themes/light/main.css" />
  <script src="https://js.arcgis.com/4.28/"></script>
  
  <style>
    html,
    body,
    #viewDiv {
      padding: 0;
      margin: 0;
      height: 100%;
      width: 100%;
    }
    
    #info {
      position: absolute;
      top: 15px;
      left: 15px;
      padding: 10px 15px;
      background-color: white;
      border-radius: 5px;
      box-shadow: 0 1px 2px rgba(0,0,0,0.3);
      font-family: Arial, sans-serif;
      font-size: 14px;
      max-width: 300px;
      z-index: 99;
    }
    
    #info p {
      margin: 5px 0;
      font-size: 12px;
      color: #666;
    }
    
    .feature-item {
      padding: 8px;
      border-bottom: 1px solid #eee;
      cursor: pointer;
      transition: background-color 0.2s;
    }
    
    .feature-item:hover {
      background-color: #f0f8ff;
    }
    
    .feature-item:last-child {
      border-bottom: none;
    }
  </style>

  <script>
    require([
      "esri/WebMap",
      "esri/views/MapView",
      "esri/core/reactiveUtils",
      "esri/geometry/geometryEngine"
    ], function(WebMap, MapView, reactiveUtils, geometryEngine) {

      // âš™ï¸ é…ç½®å‚æ•°
      const MAX_ZOOM_LEVEL = 16;
      
      const webmap = new WebMap({
        portalItem: {
          id: "08bde04a3f5b42afbf91156c57182c30"
        }
      });

      const view = new MapView({
        container: "viewDiv",
        map: webmap,
        popup: {
          dockEnabled: true,
          dockOptions: {
            buttonEnabled: true,
            breakpoint: false,
            position: "top-right"
          },
          collapseEnabled: false
        }
      });

      view.when(function() {
        console.log("âœ… åœ°å›¾åŠ è½½å®Œæˆ");
        
        webmap.layers.forEach(function(layer) {
          console.log("ğŸ“‚ å›¾å±‚:", layer.title, "| ç±»å‹:", layer.type);
          
          if (layer.featureReduction && layer.featureReduction.type === "cluster") {
            console.log("ğŸ¯ æ‰¾åˆ°èšåˆå›¾å±‚:", layer.title);
            setupClusterClickHandler(layer);
          }
        });
      });

      function setupClusterClickHandler(layer) {
        view.on("click", function(event) {
          view.hitTest(event).then(function(response) {
            const clusterResult = response.results.find(function(result) {
              return result.graphic && result.graphic.layer === layer;
            });

            if (clusterResult) {
              const graphic = clusterResult.graphic;
              
              if (graphic.isAggregate) {
                const clusterCount = graphic.attributes.cluster_count;
                const currentZoom = view.zoom;
                
                console.log("ğŸ“ ç‚¹å‡»èšåˆç‚¹ | åŒ…å«:", clusterCount, "ä¸ªè¦ç´  | ç¼©æ”¾:", currentZoom.toFixed(2));
                
                if (currentZoom >= MAX_ZOOM_LEVEL) {
                  console.log("ğŸ” æ˜¾ç¤ºèšåˆä¿¡æ¯");
                  event.stopPropagation();
                  showClusterInfo(graphic, layer);
                } else {
                  console.log("ğŸ” æ”¾å¤§åˆ°èšåˆåŒºåŸŸ");
                  event.stopPropagation();
                  zoomToCluster(graphic, layer);
                }
              } else {
                console.log("ğŸ“Œ ç‚¹å‡»äº†å•ä¸ªè¦ç´ ");
                event.stopPropagation();
                showSingleFeatureInfo(graphic);
              }
            }
          });
        });
        
        view.on("pointer-move", function(event) {
          view.hitTest(event).then(function(response) {
            const clusterResult = response.results.find(function(result) {
              return result.graphic && result.graphic.layer === layer;
            });
            
            if (clusterResult) {
              view.container.style.cursor = "pointer";
            } else {
              view.container.style.cursor = "default";
            }
          });
        });
      }

      // ğŸ”§ ä¿®å¤ï¼šä½¿ç”¨ç©ºé—´æŸ¥è¯¢è·å–èšåˆå†…çš„è¦ç´ 
      function showClusterInfo(clusterGraphic, layer) {
        console.log("ğŸ” å¼€å§‹æŸ¥è¯¢èšåˆå†…çš„è¦ç´ ...");
        console.log("èšåˆç‚¹ä½ç½®:", clusterGraphic.geometry.longitude, clusterGraphic.geometry.latitude);
        console.log("èšåˆç‚¹å£°æ˜åŒ…å«:", clusterGraphic.attributes.cluster_count, "ä¸ªè¦ç´ ");
        
        // æ–¹æ³•1: å…ˆå°è¯•ä½¿ç”¨ aggregateIds
        const query1 = layer.createQuery();
        query1.aggregateIds = [clusterGraphic.getObjectId()];
        
        layer.queryFeatures(query1).then(function(result) {
          console.log("ğŸ“Š æ–¹æ³•1 (aggregateIds) è¿”å›:", result.features.length, "ä¸ªè¦ç´ ");
          
          // æ£€æŸ¥è¿”å›çš„æ•°é‡æ˜¯å¦åˆç†
          const expectedCount = clusterGraphic.attributes.cluster_count;
          
          if (result.features.length === expectedCount || 
              (result.features.length > 0 && result.features.length < expectedCount * 2)) {
            // è¿”å›æ•°é‡åˆç†ï¼Œä½¿ç”¨è¿™ä¸ªç»“æœ
            console.log("âœ… ä½¿ç”¨æ–¹æ³•1çš„ç»“æœ");
            displayClusterFeatures(result.features, clusterGraphic);
          } else {
            // è¿”å›æ•°é‡ä¸å¯¹ï¼Œå°è¯•æ–¹æ³•2
            console.log("âš ï¸ æ–¹æ³•1è¿”å›çš„æ•°é‡ä¸å¯¹ï¼Œå°è¯•æ–¹æ³•2 (ç©ºé—´æŸ¥è¯¢)");
            queryByGeometry(clusterGraphic, layer);
          }
        }).catch(function(error) {
          console.error("âŒ æ–¹æ³•1å¤±è´¥:", error);
          console.log("å°è¯•æ–¹æ³•2 (ç©ºé—´æŸ¥è¯¢)");
          queryByGeometry(clusterGraphic, layer);
        });
      }
      
      // æ–¹æ³•2: ä½¿ç”¨ç©ºé—´æŸ¥è¯¢
      function queryByGeometry(clusterGraphic, layer) {
        // åˆ›å»ºä¸€ä¸ªèšåˆç‚¹å‘¨å›´çš„å°ç¼“å†²åŒº
        const point = clusterGraphic.geometry;
        
        // æ ¹æ®ç¼©æ”¾çº§åˆ«åŠ¨æ€è®¡ç®—ç¼“å†²è·ç¦»
        let bufferDistance;
        if (view.zoom >= 18) {
          bufferDistance = 50;    // 50ç±³
        } else if (view.zoom >= 16) {
          bufferDistance = 100;   // 100ç±³
        } else if (view.zoom >= 14) {
          bufferDistance = 500;   // 500ç±³
        } else {
          bufferDistance = 1000;  // 1å…¬é‡Œ
        }
        
        console.log("ğŸ” ä½¿ç”¨ç©ºé—´æŸ¥è¯¢ï¼Œç¼“å†²è·ç¦»:", bufferDistance, "ç±³");
        
        const query2 = layer.createQuery();
        query2.geometry = point;
        query2.distance = bufferDistance;
        query2.units = "meters";
        query2.spatialRelationship = "intersects";
        query2.returnGeometry = true;
        
        layer.queryFeatures(query2).then(function(result) {
          console.log("ğŸ“Š æ–¹æ³•2 (ç©ºé—´æŸ¥è¯¢) è¿”å›:", result.features.length, "ä¸ªè¦ç´ ");
          
          if (result.features.length > 0) {
            displayClusterFeatures(result.features, clusterGraphic);
          } else {
            // å¦‚æœè¿˜æ˜¯æ²¡æœ‰ç»“æœï¼Œæ˜¾ç¤ºé”™è¯¯
            view.popup.open({
              title: "âš ï¸ æ— æ³•åŠ è½½è¯¦ç»†ä¿¡æ¯",
              content: "è¯¥èšåˆç‚¹åŒ…å« " + clusterGraphic.attributes.cluster_count + " ä¸ªä½ç½®ï¼Œä½†æ— æ³•æŸ¥è¯¢åˆ°è¯¦ç»†æ•°æ®ã€‚",
              location: clusterGraphic.geometry
            });
          }
        }).catch(function(error) {
          console.error("âŒ æ–¹æ³•2ä¹Ÿå¤±è´¥:", error);
          view.popup.open({
            title: "âš ï¸ æŸ¥è¯¢å¤±è´¥",
            content: "æ— æ³•è·å–èšåˆç‚¹çš„è¯¦ç»†ä¿¡æ¯ã€‚é”™è¯¯: " + error.message,
            location: clusterGraphic.geometry
          });
        });
      }
      
      // æ˜¾ç¤ºèšåˆå†…çš„è¦ç´ åˆ—è¡¨
      function displayClusterFeatures(features, clusterGraphic) {
        console.log("âœ… å‡†å¤‡æ˜¾ç¤º", features.length, "ä¸ªè¦ç´ ");
        
        const popupContent = createClusterPopupContent(features);
        
        view.popup.open({
          title: "ğŸ“ èšåˆç‚¹è¯¦æƒ… (" + features.length + " ä¸ªä½ç½®)",
          content: popupContent,
          location: clusterGraphic.geometry
        });
      }
      
      function showSingleFeatureInfo(graphic) {
        console.log("ğŸ“‹ æ˜¾ç¤ºå•ä¸ªè¦ç´ è¯¦ç»†ä¿¡æ¯");
        const detailContent = createSingleFeatureContent(graphic);
        view.popup.open({
          title: "ğŸ“ ä½ç½®è¯¦æƒ…",
          content: detailContent,
          location: graphic.geometry
        });
      }

      function createClusterPopupContent(features) {
        const container = document.createElement("div");
        container.style.maxHeight = "400px";
        container.style.overflowY = "auto";
        
        const summary = document.createElement("div");
        summary.style.padding = "10px";
        summary.style.backgroundColor = "#f0f8ff";
        summary.style.marginBottom = "10px";
        summary.style.borderRadius = "4px";
        summary.innerHTML = "<strong>ğŸ“Š æ€»è®¡: " + features.length + " ä¸ªä½ç½®</strong>";
        container.appendChild(summary);
        
        features.forEach(function(feature, index) {
          const item = document.createElement("div");
          item.className = "feature-item";
          
          let content = "<strong>ä½ç½® " + (index + 1) + "</strong><br>";
          
          const attrs = feature.attributes;
          let attrCount = 0;
          for (let key in attrs) {
            if (attrs.hasOwnProperty(key) && key !== "OBJECTID" && key !== "Shape" && key !== "FID") {
              const value = attrs[key];
              if (value !== null && value !== undefined && value !== "") {
                content += "<small>" + key + ": " + value + "</small><br>";
                attrCount++;
                if (attrCount >= 3) break;
              }
            }
          }
          
          if (feature.geometry) {
            content += "<small style='color: #999;'>åæ ‡: " + 
                      feature.geometry.longitude.toFixed(6) + ", " + 
                      feature.geometry.latitude.toFixed(6) + "</small>";
          }
          
          item.innerHTML = content;
          item.addEventListener("click", function() {
            highlightFeature(feature);
          });
          
          container.appendChild(item);
        });
        
        return container;
      }

      function highlightFeature(feature) {
        if (feature.geometry) {
          view.goTo({
            center: [feature.geometry.longitude, feature.geometry.latitude],
            zoom: Math.max(view.zoom, 18),
            duration: 800
          }).then(function() {
            console.log("âœ… å·²å®šä½åˆ°è¦ç´ ");
            const detailContent = createSingleFeatureContent(feature);
            view.popup.close();
            setTimeout(function() {
              view.popup.open({
                title: "ğŸ“ ä½ç½®è¯¦æƒ…",
                content: detailContent,
                location: feature.geometry
              });
            }, 500);
          });
        }
      }
      
      function createSingleFeatureContent(feature) {
        const container = document.createElement("div");
        container.style.padding = "10px";
        container.style.maxHeight = "400px";
        container.style.overflowY = "auto";
        
        const attrs = feature.attributes;
        let hasContent = false;
        
        for (let key in attrs) {
          if (attrs.hasOwnProperty(key)) {
            const value = attrs[key];
            
            if (key === "OBJECTID" || key === "Shape" || key === "FID") {
              continue;
            }
            
            if (value !== null && value !== undefined && value !== "") {
              hasContent = true;
              
              const row = document.createElement("div");
              row.style.marginBottom = "8px";
              row.style.paddingBottom = "8px";
              row.style.borderBottom = "1px solid #eee";
              
              const label = document.createElement("div");
              label.style.fontWeight = "bold";
              label.style.color = "#333";
              label.style.fontSize = "13px";
              label.style.marginBottom = "3px";
              label.textContent = key;
              
              const valueDiv = document.createElement("div");
              valueDiv.style.color = "#666";
              valueDiv.style.fontSize = "14px";
              valueDiv.textContent = value;
              
              row.appendChild(label);
              row.appendChild(valueDiv);
              container.appendChild(row);
            }
          }
        }
        
        if (!hasContent) {
          const noData = document.createElement("div");
          noData.style.color = "#999";
          noData.style.textAlign = "center";
          noData.style.padding = "20px";
          noData.textContent = "è¯¥ä½ç½®æ²¡æœ‰è¯¦ç»†ä¿¡æ¯";
          container.appendChild(noData);
        }
        
        if (feature.geometry) {
          const coordDiv = document.createElement("div");
          coordDiv.style.marginTop = "10px";
          coordDiv.style.paddingTop = "10px";
          coordDiv.style.borderTop = "2px solid #0066cc";
          coordDiv.style.fontSize = "12px";
          coordDiv.style.color = "#999";
          coordDiv.innerHTML = "<strong>ğŸ“ åæ ‡ä½ç½®</strong><br>" +
                              "ç»åº¦: " + feature.geometry.longitude.toFixed(6) + "<br>" +
                              "çº¬åº¦: " + feature.geometry.latitude.toFixed(6);
          container.appendChild(coordDiv);
        }
        
        return container;
      }

      function zoomToCluster(clusterGraphic, layer) {
        const query = layer.createQuery();
        query.aggregateIds = [clusterGraphic.getObjectId()];
        
        layer.queryFeatures(query).then(function(result) {
          console.log("ğŸ“Š èšåˆç‚¹åŒ…å«", result.features.length, "ä¸ªè¦ç´ ");
          
          if (result.features.length > 0) {
            let extent = null;
            result.features.forEach(function(feature) {
              if (feature.geometry) {
                if (!extent) {
                  extent = feature.geometry.extent.clone();
                } else {
                  extent = extent.union(feature.geometry.extent);
                }
              }
            });
            
            if (extent) {
              extent = extent.expand(1.5);
              view.goTo({
                target: extent,
                duration: 1000
              }).catch(function(error) {
                if (error.name !== "AbortError") {
                  console.error("âŒ æ”¾å¤§å¤±è´¥:", error);
                }
              });
            }
          }
        }).catch(function(error) {
          console.error("âŒ æŸ¥è¯¢èšåˆè¦ç´ å¤±è´¥:", error);
          if (clusterGraphic.geometry) {
            view.goTo({
              center: [clusterGraphic.geometry.longitude, clusterGraphic.geometry.latitude],
              zoom: view.zoom + 2,
              duration: 1000
            });
          }
        });
      }

      reactiveUtils.watch(
        () => view.zoom,
        (zoom) => {
          console.log("ğŸ” å½“å‰ç¼©æ”¾çº§åˆ«:", zoom.toFixed(2));
          const infoDiv = document.getElementById("zoom-info");
          if (infoDiv) {
            if (zoom >= MAX_ZOOM_LEVEL) {
              infoDiv.textContent = "å½“å‰çº§åˆ«: " + zoom.toFixed(1) + " (ç‚¹å‡»èšåˆç‚¹æŸ¥çœ‹è¯¦æƒ…)";
              infoDiv.style.color = "#0066cc";
            } else {
              infoDiv.textContent = "å½“å‰çº§åˆ«: " + zoom.toFixed(1) + " (ç‚¹å‡»èšåˆç‚¹æ”¾å¤§)";
              infoDiv.style.color = "#666";
            }
          }
        }
      );
    });
  </script>
</head>

<body>
  <div id="viewDiv"></div>
  <div id="info">
    <strong> ä½¿ç”¨è¯´æ˜ </strong>
    <p>â€¢ ç‚¹å‡»èšåˆæ•°å­—å¯æ”¾å¤§åœ°å›¾</p>
    <p>â€¢ åˆ°è¾¾ç¼©æ”¾çº§åˆ« 16+ åï¼Œç‚¹å‡»æ˜¾ç¤ºèšåˆå†…çš„ä½ç½®åˆ—è¡¨</p>
    <p>â€¢ ç‚¹å‡»åˆ—è¡¨é¡¹å®šä½å¹¶æŸ¥çœ‹è¯¥ä½ç½®è¯¦æƒ…</p>
    <p>â€¢ ç‚¹å‡»å•ä¸ªç‚¹åªæ˜¾ç¤ºè¯¥ç‚¹çš„è¯¦ç»†ä¿¡æ¯</p>
    <p id="zoom-info" style="margin-top: 8px; font-weight: bold;">å½“å‰çº§åˆ«: --</p>
  </div>
</body>
</html>
